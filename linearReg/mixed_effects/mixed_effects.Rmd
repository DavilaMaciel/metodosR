---
title       : "Modelos Mistos"
subtitle    : "Análise de dados com modelos lineares em R"
author      : "Nicholas A. C. Marino"
job         : "Universidade Federal do Rio de Janeiro"
date        : "github.com/nacmarino/metodosR"
output:
  html_document:
    widescreen: true
    smaller: true
---

## Modelos mistos  
  
* Por vezes nosso desenho experimental incorpora elementos que devemos considerar nos modelos:
    + Blocos espaciais e/ou temporais  
    + Medidas repetidas nos mesmos indivíduos    
    + Observações aninhadas dentro de grupos    
    + Auto-correlação espacial ou temporal    
    + Variância não homogênea entre grupos  
    
* Para tanto, utilizamos modelos mistos, que incoporam as variáveis preditoras fixas (do nosso interesse) e também as variáveis preditoras aleatórias (no geral, não são de nosso interesse) - por isso são chamado de _modelos mistos_.  

## Modelos mistos  

* Podemos incorporar uma variável aleatória como um:
    + Intercepto: os níveis do fator modificam os valores médios da variável resposta (intercepto da regressão difere, slopes podem ser semelhantes)  
    + Slope: os níveis do fator modificam a relação da variável resposta com as variáveis preditoras (slopes podem variar de acordo com os níveis)  

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=3.5, fig.height=3.5}
ilhas <- read.table(file = "../model_selection/dados/ilhas.txt", header = TRUE)
library(ggplot2)
ggplot(data = ilhas, mapping = aes(x = log10(area), y = log10(riqueza))) +
  geom_smooth(aes(colour = arquipelago), method = "lm", se = FALSE, show.legend = FALSE, size = 3) +
  geom_smooth(se = FALSE, show.legend = FALSE, size = 3, method = "lm", colour = "black", linetype = 2) +
  theme_bw() +
  xlab("") +
  ylab("")
```

## Modelos mistos | Intercepto aleatório

* Por exemplo, um modelo linear somente com várias fixas:  

<center> _y_ = $\beta$~0~ + $\beta$~1~ * _x~1~_ + $\epsilon$ </center>

* Adicionando uma variável aleatória, como um intercepto aleatório no modelo:  

<center> _y_ = ($\beta$~0~ + **$\omega$~i~**) + $\beta$~1~ * _x~1~_ + ($\epsilon$ + **$\epsilon$~i~**) </center>

## Modelos mistos | Slope aleatório

* Por exemplo, um modelo linear somente com várias fixas:  

<center> _y_ = $\beta$~0~ + $\beta$~1~ * _x~1~_ + $\epsilon$ </center>

* Adicionando uma variável aleatória, como um slope aleatório no modelo:  

<center> _y_ = $\beta$~0~ + ($\beta$~1~ + **$\omega$~i~**) * _x~1~_ + ($\epsilon$ + **$\epsilon$~i~**) </center>

## Modelos lineares mistos

* Os parâmetros dos modelos lineares mistos são determinados através de dois métodos:  
    + Maximum Likelihood (ML)  
    + Restricted Maximum Likelihood (REML)  
  
* REML é o método padrão para o cálculo da estimativa dos parâmetros.  
  
* O REML é mais robusto do que o ML, pois corrige as estimativas dos parâmetros através da correção pelo número de graus de liberdade do modelo.  

* Como consequência, normalmente utilizamos ML para fazer a seleção de modelos e o REML para validar o modelo e determinar a estimativa final dos parâmetros.  

## Modelos mistos

* No R, modelos mistos são implementados através dos pacotes `nlme` e `lme4`:
    + `nlme::lme`: modelos lineares mistos, com boas funcionalidades para inclusão de estruturas de autocorrelação e de diferenças na variância entre grupos (`correlation` e `weights`)  
    
    + `lme4::lmer`: modelos lineares mistos (distribuição normal)  
    
    + `lme4::glmer`: modelos lineares generalizados mistos (**danger zone**), implementa a funcionalidade das GLMs nos modelos mistos - teoria ainda em desenvolvido (tende à instabilidade e pode ser temperamental)  
  
* Todas as boas práticas de seleção e validação de modelos que aprendemos para a `glm` valem para os modelos mistos.  

## Modelos lineares mistos

* Vamos implementar um modelo misto no conjunto de dados que estamos trabalhando.  
  
* Vamos utilizar o tipo de ilha como uma variável aleatória: a relação espécies-área é válida apenas para o subconjunto de dados que temos OU a relação é existente apesar da heterogeneidade entre tipos de ilhas?  
  
```{r warning=FALSE, message=FALSE}
ilhas <- read.table(file = "../model_selection/dados/ilhas.txt", header = TRUE)
library(lme4)
modelo1 <- lmer(log10(riqueza) ~ arquipelago + log10(area) + (1|ilha), data = ilhas)
```
  
* No `nlme` usaríamos: `lme(log10(riqueza) ~ log10(area) + arquipelago, random = ~ 1|ilha, data = ilhas)`

## Modelos lineares mistos

```{r echo=FALSE}
summary(modelo1)
```

## Modelos lineares mistos | Seleção e Diagnóstico de Modelos
  
* A seleção e o diagnóstico dos modelos seguem as mesmas recomendações apresentadas anteriormente;  
* Você também pode calcular o valor de r^2^ com os modelos mistos.  
    + r^2^ marginal (**R2m**): somente as variáveis fixas
    + r^2^ condicional (**R2c**): variáveis fixas + variáveis aleatórias

```{r warning=FALSE, message=FALSE}
library(MuMIn)
r.squaredGLMM(modelo1)
```

## Modelos lineares mistos | Seleção e Diagnóstico de Modelos
  
* Você pode comparar os modelos com e sem as variáveis aleatórias?
    + Poder você pode, mas não deveria (afinal, isso não faz parte do seu desenho experimental?)
    + Testes de verossimilhança entre modelos mistos e os modelos normais não são comparáveis
* O pacote `lmerTest` implementa algumas funcionalidades para trabalhar LMMs.  
    + `step`: seleção de modelos.  
    + `rand`: testes de verossimilhança para as variáveis aleatórias.  
    + `difflsmeans`: pós-teste.  

## Modelos lineares mistos

* Vamos olhar o modelo com calma: o pacote `broom`, função `tidy`.  
* Podemos ver que a inclusão do intercepto aleatório adiciona dois parâmetros extras:  
    + o intercepto para o tipo de ilha  
    + um valor de resíduo (erro) para cada observação em cada tipo de ilha  
* Note, no entanto, que não existe estimativa de erro e nem uma estatística para estes dois parâmetros - __qual a consequência?__  

```{r}
broom::tidy(modelo1)
```

## Modelos lineares mistos | Significância dos Termos no Modelo

* Calcular os valores de significância dos termos em modelos lineares mistos não é fácil;  
* Erro dos termos no modelo, principalmente os aleatórios, pode não ser tão fáceis de estimar;  
* Graus de liberdade do modelo não são exatos;  
* Como consequência:  
    + Não podemos calcular valores de significância para os termos do modelo;
    + Precisamos aproximar os valores dos graus de liberdade para conseguirmos realizar os cálculos.  

```{r warning=FALSE, message=FALSE}
library(car) 
Anova(modelo1, type = "II", test.statistic = "F") # certo?
```

## Modelos lineares mistos | Significância dos Termos no Modelo

* O criador do pacote `lme4` faz algumas sugestões (do pior para o melhor): [http://glmm.wikidot.com/faq]
    1. Wald chi-square testes (car::Anova)  
    2. Likelihood ratio test (via anova ou drop1)  
    3. Conditional F-tests  
    4. Para LMMs apenas, conditional F-tests com correção para os graus de liberdade (Kenward-Roger ou Satterthwaite)  
    5. Testes de aleatorização  
* Para a opção 4: `lmerTest::anova`  

```{r}
lmerTest::anova(object = modelo1, type = 2, ddf = "Satterthwaite")
```

## Modelos generalizados lineares mistos | Panorama geral  

* Os modelos mistos também possuem uma versão para incoporar outras distribuições estatísticas no seu modelo: GLMMs.  
  
* Teoria ainda em desenvolvimento e não são tão estáveis, ainda (mas veja a opção do pacote `glmmADMB`).  
  
* De toda forma, você pode implementar ele - e todas as recomendações para os outros modelos também valem aqui.  
  
* Para calcular a __overdispersion__ existe uma função, fornecida pelo próprio criador do pacote `lme4`.  

```{r}
source("../../R functions/overdisp.R")
```

## Modelos generalizados lineares mistos | Panorama geral  

```{r warning=FALSE, message=FALSE}
modelo2 <- glmer(mamiferos ~ arquipelago + log10(area) + (1|ilha), data = ilhas, family = poisson())
r.squaredGLMM(modelo2)
overdisp_fun(modelo2)
```

## Modelos generalizados lineares mistos | Panorama geral  

```{r}
summary(modelo2)
```

## Considerações finais  

* Modelos mistos te permitem incorporar algumas especificidades do seu desenho experimental/amostral no modelo - inclusive algumas que envolvem a violação de pressupostos estatísticos.  
  
* As mesmas recomendações que valem para a seleção e diagnóstico de modelos para `lm` e `glm` valem para os modelos mistos (`nlme`, `lmer` e `glmer`).  
  
* Tanto o `lme` quanto o `lmer` implementam modelos lineares mistos, mas a forma como fazem isso difere um pouco - qual usar?  
    + O que se adequar melhor ao seu desenho experimental/amostral  
    + Lembrando que o `lme` permite a incoporação de diferenças na variância entre os níveis de fatores e de autocorrelação  
  
* O `lme4` também implementa as GLMMs (`glmer`), seguindo a mesma lógica das GLMs - mas cuidado ao usar estes modelos, pois eles combinam a complexidade das GLMs com as dos modelos mistos (e ainda estão em fase de desenvolvimento).    