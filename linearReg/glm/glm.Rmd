---
title       : "Generalized Linear Models"
subtitle    : "Análise de dados com modelos lineares em R"
author      : "Nicholas A. C. Marino"
job         : "Universidade Federal do Rio de Janeiro"
date        : "github.com/nacmarino/metodosR"
output:
  html_document:
    widescreen: true
    smaller: true
---

## General and Generalized Linear Models

* Conhecido como GLMs;  
  
* É uma classe de modelos lineares que permite relacionar uma variável resposta com múltiplas variáveis preditoras, contínuas e/ou categóricas;  
  
* O forte desta classe de modelos é que ele pode ser usado quando os resíduos de uma modelo linear não são normais.  
    + General Linear Models: distribuição dos resíduos do modelo segue a distribuição normal  
    + General**ized** Linear Models: distribuição dos resíduos do modelo não segue a distribuição normal  

* Uma vantagem: os valores das estimativas dos parâmetros são feitos na própria escala da variável resposta.  
 
## GLMs

* Implementado pela função `stats::glm` no R;  
* Possui dois argumentos importantes:  
    + *family*: determina qual distribuição que descreve a estrutura dos resíduos do modelo  
    + *link*: determina como o __valor esperado__ da variável resposta se relaciona com o modelo  
* No geral, selecionamos `family` "à vontade", mas não é recomendado alterar o `link`.  

```{r}
args(glm)
```

## GLMs | family & link  
  
*  Variável resposta é __contínua__:  
    + gaussian: identity, log, sqrt, inverse  
    + inverse.gaussian: identity, 1/mu^2, inverse, log  
    + Gamma: reciprocal, identity, inverse, log  
    + quasi: identity, logit, probit, cloglog, inverse, 1/mu^2, sqrt, power  
  
*  Variável resposta é __discreta__:    
    + poisson: log, identity, sqrt  
    + quasipoisson: identity, logit, probit, cloglog  
    + binomial: logit, probit, cauchit, log, cloglog  
    + quasibinomial: identity, log, profit, cloglog  
    + negative binomial (MASS::glm.nb): identity, log, sqrt  
    
## GLMs

* A escolha da família para a GLM vai depender da variável resposta.  
    + Contínua ou categórica?  
    + Contagens, razões, proporções?  
    + Existem muitos valores "0"?  
    + Qual o valor mínimo registrado para a variável resposta?  
  
* O erro na seleção da família para o GLM é mais grave do que o erro de especificar uma função _link_ errada.  

## Overdispersion  

* Qual o problema da overdispersion no contexto da GLM?
* Vamos simular um conjunto de dados.  

```{r}
set.seed(33)
dados <- round((rnorm(n = 100, mean = 1500, sd = 600)))
dados
```

## Overdispersion

* Qual o problema da overdispersion no contexto da GLM?

```{r warning=FALSE, message=FALSE}
library(fitdistrplus)
fitdist(dados, "pois")
fitdist(dados, "norm")
```

## Overdispersion

```{r echo=FALSE, fig.align='center', fig.width=8, fig.height=5}
dt1 <- fitdist(dados, "norm")$estimate
dt2 <- fitdist(dados, "pois")$estimate
dt2[2] <- fitdist(dados, "pois")$sd
par(mfrow = c(1,2))
hist(dados)
lines(x = c(dt1[1], dt1[1]), y = c(0, 30), lty = 1, col = "blue", lwd = 3)
lines(x = c(dt1[1] - dt1[2], dt1[1] - dt1[2]), y = c(0, 30), lty = 2, col = "blue", lwd = 3)
lines(x = c(dt1[1] + dt1[2], dt1[1] + dt1[2]), y = c(0, 30), lty = 2, col = "blue", lwd = 3)
hist(dados)
lines(x = c(dt2[1], dt2[1]), y = c(0, 30), lty = 1, col = "red", lwd = 1)
lines(x = c(dt2[1] - dt2[2], dt2[1] - dt2[2]), y = c(0, 30), lty = 2, col = "red", lwd = 3)
lines(x = c(dt2[1] + dt2[2], dt2[1] + dt2[2]), y = c(0, 30), lty = 2, col = "red", lwd = 3)
```

## Overdispersion

* A estimativa do erro de um parâmetro é __subestimada__ - a distribuição estatística prevê que a dispersão do conjunto de dados é menor do que real.  
  
* Outra forma de ver isso: os dados estão mais dispersos do que o esperado pela distribuição estatística.  
  
* Ocorre principalmente quando tentamos utilizar a distribuição `poisson` ou `binomial` - ambas assumem que a variância é igual à média.  
  
* No mundo real, os dados dificilmente segue esse mesmo pressuposto.
  
* A estimativa de um parâmetro torna-se muito precisa, mas o parâmetro passa a não descrever o conjunto de dados adequadamente.  

* Muita atenção ao selecionar o tipo de distribuição para a variável resposta - diagnóstico e validação dos modelos é fundamental.  

## De volta ao nosso exemplo

```{r}
ilhas <- read.table(file = "../model_selection/dados/ilhas.txt", header = TRUE)
modelo1 <- glm(log10(riqueza) ~ log10(area) + ilha + arquipelago, data = ilhas)
modelo1
```

## GLM | Distribuição de Poisson

* Usado principalmente para variável resposta discreta, como contagens.  
* Todavia, também pode ser usado quando a variável resposta é contínua:  
    + Taxas: por exemplo, evento ocorre em 5 de cada 1000 observações...    
    + Proporções: por exemplo, 10 de cada 20 pessoas fazem...  
    + Contagens por unidade: por exemplo, 14 indivíduos por m²...  
* Em ecologia: utilizado para modelar dados de abundância e/ou densidade.  

```{r}
modelo2 <- glm(riqueza ~ log10(area) + ilha + arquipelago, data = ilhas, family = poisson())
```

## GLM | Distribuição de Poisson

* Compare os coeficientes do modelo anterior com aquele previsto pelo modelo utilizando a distribuição de Poisson.  

```{r}
modelo1$coefficients
modelo2$coefficients
```

## GLM | Distribuição de Poisson

* A razão entre a __Deviance__ e o __Residual df__ pode dar uma estimativa do grau de __overdispersion__ em um GLM com distribuição de Poisson.  

```{r}
modelo2
```

## GLM | Distribuição de Poisson

* Se o valor de $\theta$ é maior do que 1, então existe evidência de __overdispersion__ no modelo.  
  
<center> $\theta$ = deviance/df.residual < 1 </center>
  
```{r}
theta <- modelo2$deviance/modelo2$df.residual
theta
```

## GLM | Distribuição de Poisson  

* Soluções:  
  
    1. Dividir os valores da variável resposta pelo valor de theta;  
    2. Tentar outra função link;  
    3. Tentar outra distribuição estatística - por exemplo, a família _quasi_;  
    4. Transformar o dado original e usar a distribuição normal.  
  
* Mas não perca a esperança: a distribuição de Poisson pode ser útil!  

## GLM | Distribuição de Poisson  

* Podemos utilizar a distribuição de Poisson para avaliar como o número de espécies de mamíferos varia em função das mesmas variáveis que havíamos analisado para a riqueza de espécies.  
  
* Existe pouca evidência de que existe __overdispersion__ nestes dados.  

```{r}
modelo3 <- glm(mamiferos ~ log10(area) + ilha + arquipelago, data = ilhas, family = poisson())
modelo3$deviance/modelo3$df.residual
```

## GLM | Distribuição de Poisson  

* Uma forma de visualizar rapidamente os resultados do seu modelo (as predições) é através da função `visreg::visreg`.  

```{r warning=FALSE, message=FALSE, fig.align='center', fig.width=5, fig.height=3.5}
library(visreg)
visreg(modelo3)
```

## GLM | Distribuição Binomial  

* Utilizada principalmente para modelar probabilidades:  
    + Qual a probabilidade do evento **x** ocorrer?  
    + Como um fenômeno **x** varia em função de **y**?  
  
* Sofre dos mesmo problemas da GLM com distribuição de Poisson.  

## GLM | Distribuição Binomial  

* Como a probabilidade de encontrarmos espécies de mamíferos muda com a área e tipo da ilha, e também do tamanho do arquipélago?

```{r}
modelo4 <- glm(cbind(riqueza, mamiferos) ~ log10(area) * ilha + arquipelago, data = ilhas, family = binomial())
modelo4
modelo4$deviance/modelo4$df.residual
```

## Considerações finais  

* Os GLMs são uma poderosa ferramenta para analisar os seus dados.  

* A escolha da família e link para o GLM deve ser baseada na natureza do dado que você possui.  
  
* O processo de criação, seleção e validação de modelo é o mesmo que o visto anteriormente.  
  
* É bastante importante ficar atento à possibilidade de __overdispersion__ no modelo, especialmente quando utilizar a distribuição de Poisson ou Binomial.  